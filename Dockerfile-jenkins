FROM jenkins/jenkins:2.440.3-jdk11

USER root

# Instalar dependências de sistema e Docker CLI
RUN apt-get update && \
    apt-get install -y python3 python3-pip python3-venv python3-dev build-essential git curl docker.io

# Criar ambiente virtual para evitar erro PEP 668
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Instalar pacotes Python da aplicação no venv
COPY requirements.txt /tmp/requirements.txt
RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r /tmp/requirements.txt

# Adicionar usuário jenkins ao grupo docker
RUN groupadd docker || true && usermod -aG docker jenkins

# Copiar plugins e scripts de inicialização
COPY plugins.txt /usr/share/jenkins/ref/plugins.txt
COPY jenkins/1-configureJenkins.groovy /usr/share/jenkins/ref/init.groovy.d/
COPY jenkins/2-addAccessKeys.groovy /usr/share/jenkins/ref/init.groovy.d/

# Instalar plugins do Jenkins
USER jenkins
RUN jenkins-plugin-cli --plugin-file /usr/share/jenkins/ref/plugins.txt